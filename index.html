<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Excel with ExcelJS and Extract Negative Values</title>
</head>
<body>
    <h2>Select Excel files to display their content and extract negative values</h2>
    <input type="file" id="file-input" multiple accept=".xlsx, .xls" />
    <div id="file-content" style="white-space: pre-wrap; margin-top: 20px;"></div>
    <div id="negative-values" style="white-space: pre-wrap; margin-top: 20px;"></div>
    <div id="summary" style="white-space: pre-wrap; margin-top: 20px;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.2.1/exceljs.min.js"></script>

    <script>
        document.getElementById('file-input').addEventListener('change', function(event) {
            const files = event.target.files;
            if (files.length === 0) {
                alert('Please select a file!');
                return;
            }

            const fileContentContainer = document.getElementById('file-content');
            const negativeValuesContainer = document.getElementById('negative-values');
            const summaryContainer = document.getElementById('summary');
            fileContentContainer.innerText = "Processing files...\n";
            negativeValuesContainer.innerText = "";  // Clear previous results
            summaryContainer.innerText = "";  // Clear previous summary

            let totalNegativeValues = 0;
            let sumNegativeValues = 0;
            let allNegativeValues = []; // Collect all negative values across files

            // Loop through all selected files
            Array.from(files).forEach((file) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result;
                    const workbook = new ExcelJS.Workbook();
                    workbook.xlsx.load(data).then(function() {
                        fileContentContainer.innerText += `\nProcessing file: ${file.name}\n`;

                        let negativeValues = []; // To store negative values for this file
                        let firstNegativeSkipped = false; // Flag to skip first negative value

                        // Loop through all sheets in the workbook
                        workbook.worksheets.forEach((worksheet) => {
                            fileContentContainer.innerText += `\nSheet: ${worksheet.name}\n`;

                            // Iterate through all rows and columns in the sheet
                            worksheet.eachRow((row, rowIndex) => {
                                const rowValues = [];
                                row.values.forEach((cell, colIndex) => {
                                    // Display the cell's value
                                    rowValues.push(cell);

                                    // Check if the cell is a number and is negative
                                    if (typeof cell === 'number' && cell < 0) {
                                        // Skip the first negative value
                                        if (!firstNegativeSkipped) {
                                            firstNegativeSkipped = true;
                                            return; // Skip this negative value
                                        }

                                        // Apply value transformation if it's 34.43 or -43.31
                                        if (cell === 34.43 || cell === -43.31) {
                                            cell = (cell / 3) * 2;
                                        }

                                        // Store the negative value (if it is not the first one)
                                        negativeValues.push({
                                            row: rowIndex,
                                            col: colIndex,
                                            value: cell
                                        });
                                    }
                                });

                                // Display the row values in the file content
                                fileContentContainer.innerText += `Row ${rowIndex}: ${rowValues.join("\t")}\n`;
                            });
                        });

                        // Output the negative values for this file
                        if (negativeValues.length > 0) {
                            negativeValuesContainer.innerText += `\nNegative Values Found in ${file.name} (ignoring the first negative value):\n`;
                            negativeValues.forEach(entry => {
                                negativeValuesContainer.innerText += `Row ${entry.row}, Column ${entry.col}: ${entry.value}\n`;
                            });

                            // Add to the overall summary
                            totalNegativeValues += negativeValues.length;
                            sumNegativeValues += negativeValues.reduce((acc, entry) => acc + entry.value, 0);
                            allNegativeValues.push(...negativeValues);
                        } else {
                            negativeValuesContainer.innerText += `No negative values found in ${file.name} (after ignoring the first negative value).\n`;
                        }

                        // Final summary output
                        if (allNegativeValues.length > 0) {
                            const averageNegativeValue = sumNegativeValues / totalNegativeValues;

                            summaryContainer.innerText += `\nSummary of Negative Values across all files:\n`;
                            summaryContainer.innerText += `Total Count of Negative Values: ${totalNegativeValues}\n`;
                            summaryContainer.innerText += `Sum of Negative Values: ${sumNegativeValues.toFixed(2)}\n`;
                            summaryContainer.innerText += `Average of Negative Values: ${averageNegativeValue.toFixed(2)}\n`;
                        }
                    });
                };
                reader.readAsArrayBuffer(file); // Use ArrayBuffer to read the file
            });
        });
    </script>
</body>
</html>
