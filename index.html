<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Excel with ExcelJS and Extract Negative Values</title>
</head>
<body>
    <h2>Select an Excel file to display its content and extract negative values</h2>
    <input type="file" id="file-input" accept=".xlsx, .xls" />
    <div id="file-content" style="white-space: pre-wrap; margin-top: 20px;"></div>
    <div id="negative-values" style="white-space: pre-wrap; margin-top: 20px;"></div>
    <div id="summary" style="white-space: pre-wrap; margin-top: 20px;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.2.1/exceljs.min.js"></script>

    <script>
        document.getElementById('file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('Please select a file!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                const workbook = new ExcelJS.Workbook();
                workbook.xlsx.load(data).then(function() {
                    const fileContentContainer = document.getElementById('file-content');
                    const negativeValuesContainer = document.getElementById('negative-values');
                    const summaryContainer = document.getElementById('summary');
                    fileContentContainer.innerText = "Processing file...\n";
                    negativeValuesContainer.innerText = "";  // Clear previous results
                    summaryContainer.innerText = "";  // Clear previous summary

                    let negativeValues = []; // To store all negative values found
                    let firstNegativeSkipped = false; // Flag to skip first negative value

                    // Loop through all sheets in the workbook
                    workbook.worksheets.forEach((worksheet) => {
                        fileContentContainer.innerText += `\nSheet: ${worksheet.name}\n`;

                        // Iterate through all rows and columns in the sheet
                        worksheet.eachRow((row, rowIndex) => {
                            const rowValues = [];
                            row.values.forEach((cell, colIndex) => {
                                // Display the cell's value
                                rowValues.push(cell);
                                
                                // Check if the cell is a number and is negative
                                if (typeof cell === 'number' && cell < 0) {
                                    // Skip the first negative value
                                    if (!firstNegativeSkipped) {
                                        firstNegativeSkipped = true;
                                        return; // Skip this negative value
                                    }

                                    // Apply value transformation if it's -34.43 or -43.31
                                    if (cell === -34.43 || cell === -43.31) {
                                        cell = (cell / 3) * 2;
                                    }

                                    // Store the negative value (if it is not the first one)
                                    negativeValues.push({
                                        row: rowIndex,
                                        col: colIndex,
                                        value: cell
                                    });
                                }
                            });

                            // Display the row values in the file content
                            fileContentContainer.innerText += `Row ${rowIndex}: ${rowValues.join("\t")}\n`;
                        });
                    });

                    // Output the negative values
                    if (negativeValues.length > 0) {
                        negativeValuesContainer.innerText += "\nNegative Values Found (ignoring the first negative value):\n";
                        negativeValues.forEach(entry => {
                            negativeValuesContainer.innerText += `Row ${entry.row}, Column ${entry.col}: ${entry.value}\n`;
                        });

                        // Create the summary of negative values
                        const totalNegativeValues = negativeValues.length;
                        const sumNegativeValues = negativeValues.reduce((acc, entry) => acc + entry.value, 0);
                        const averageNegativeValue = sumNegativeValues / totalNegativeValues;

                        // Display the summary
                        summaryContainer.innerText += `\nSummary of Negative Values:\n`;
                        summaryContainer.innerText += `Total Count of Negative Values: ${totalNegativeValues}\n`;
                        summaryContainer.innerText += `Sum of Negative Values: ${sumNegativeValues.toFixed(2)}\n`;
                        summaryContainer.innerText += `Average of Negative Values: ${averageNegativeValue.toFixed(2)}\n`;
                    } else {
                        negativeValuesContainer.innerText += "No negative values found (after ignoring the first negative value).\n";
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>
