<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Excel with ExcelJS and Process Negative Values</title>
</head>
<body>
    <h2>Select months and an Excel file to process</h2>
    <div>
        <label><input type="checkbox" value="1"> Januar</label>
        <label><input type="checkbox" value="2"> Februar</label>
        <label><input type="checkbox" value="3"> Marec</label>
        <label><input type="checkbox" value="4"> April</label>
        <label><input type="checkbox" value="5"> Maj</label>
        <label><input type="checkbox" value="6"> Junij</label>
        <label><input type="checkbox" value="7"> Julij</label>
        <label><input type="checkbox" value="8"> Avgust</label>
        <label><input type="checkbox" value="9"> September</label>
        <label><input type="checkbox" value="10"> Oktober</label>
        <label><input type="checkbox" value="11"> November</label>
        <label><input type="checkbox" value="12"> December</label>
    </div>
    <input type="file" id="file-input" multiple accept=".xlsx, .xls" />
    <div id="file-content" style="white-space: pre-wrap; margin-top: 20px;"></div>
    <div id="results" style="white-space: pre-wrap; margin-top: 20px;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.2.1/exceljs.min.js"></script>

    <script>
        const monthsSlovenian = ['Januar', 'Februar', 'Marec', 'April', 'Maj', 'Junij', 'Julij', 'Avgust', 'September', 'Oktober', 'November', 'December'];

        function getMonthName(monthNumber) {
            return monthsSlovenian[monthNumber - 1];
        }

        function processFiles() {
            const selectedMonths = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(checkbox => parseInt(checkbox.value)); // Get selected month values
            const files = document.getElementById('file-input').files;
            const resultsContainer = document.getElementById('results');
            let data = [];
            let totalSum = 0;

            if (selectedMonths.length === 0) {
                resultsContainer.innerText = "Please select at least one month.";
                return;
            }

            if (files.length === 0) {
                resultsContainer.innerText = "Please upload a file.";
                return;
            }

            resultsContainer.innerText = "Processing files...\n";

            // Process each selected file
            for (let file of files) {
                let reader = new FileReader();
                reader.onload = function(event) {
                    const workbook = new ExcelJS.Workbook();
                    workbook.xlsx.load(event.target.result).then(function() {
                        let sheetName = workbook.worksheets[0].name; // Assuming the first sheet
                        let sheet = workbook.getWorksheet(sheetName);

                        console.log(`Processing Sheet: ${sheetName}`);
                        console.log("Sheet Data:", sheet);

                        let foundData = false;

                        // Iterate through all rows in the sheet and log data for debugging
                        sheet.eachRow((row, rowIndex) => {
                            console.log(`Row ${rowIndex}:`, row.values);  // Log each row

                            row.eachCell((cell, colIndex) => {
                                console.log(`Cell ${colIndex}: ${cell.value}`);  // Log each cell

                                // Check for negative numbers and process accordingly
                                if (typeof cell.value === 'number' && cell.value < 0) {
                                    // Ignore first negative value
                                    if (data.length === 0) return;

                                    // If negative value is found, check if it matches specific values
                                    if (cell.value === -34.43 || cell.value === -43.31) {
                                        cell.value = (cell.value / 3) * 2; // Apply formula to value
                                    }

                                    // Check if the row matches the selected months and store the data
                                    if (selectedMonths.includes(rowIndex)) {
                                        let monthName = getMonthName(selectedMonths[rowIndex]);
                                        data.push({ month: monthName, value: cell.value });
                                        totalSum += cell.value;
                                        foundData = true;
                                    }
                                }
                            });
                        });

                        // Log if no relevant data found
                        if (!foundData) {
                            resultsContainer.innerText += `No relevant data found in file: ${file.name}\n`;
                        }
                        if (data.length > 0) {
                            resultsContainer.innerText += `Processed file: ${file.name}\n`;
                        }

                        outputResults();
                    });
                };
                reader.readAsArrayBuffer(file); // Use ArrayBuffer to read the file
            }

            function outputResults() {
                if (data.length > 0) {
                    let finalData = [...data];
                    let results = "Processed Data:\n";
                    finalData.forEach(d => {
                        results += `Month: ${d.month}, Value: ${d.value}\n`;
                    });

                    // Calculate sum and append to results
                    let sum = finalData.reduce((acc, d) => acc + d.value, 0);
                    results += `\nTotal Sum: ${sum.toFixed(2)}`;

                    // Prepare results for divisor calculation (example used 499)
                    const divisor = 499;
                    let remainder = Math.abs(sum);
                    let divisorResults = [];

                    while (remainder >= divisor) {
                        remainder -= divisor;
                        divisorResults.push(divisor);
                    }

                    divisorResults.push(remainder);
                    results += `\n\nDivisor Results:\n${divisorResults.join('\n')}`;

                    resultsContainer.innerText = results;
                }
            }
        }

        document.getElementById('file-input').addEventListener('change', function(event) {
            processFiles();
        });
    </script>
</body>
</html>
